<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shift Scheduler</title>
  <link rel="preconnect" href="https://static.redhat.com" crossorigin>
  <link rel="stylesheet" href="https://static.redhat.com/libs/redhat/redhat-font/latest/webfonts/red-hat-font.css" />
  <link rel="stylesheet" href="/static/styles.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ee0000" />
  <script type="module">
    import 'https://unpkg.com/@rhds/elements@latest/rh-card/rh-card.js';
    import 'https://unpkg.com/@rhds/elements@latest/rh-divider/rh-divider.js';
  </script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Shift Scheduler</h1>
    </header>

    <div class="layout">
      <nav class="sidebar" aria-label="Primary">
        <ul>
          <li><button class="nav-item is-active" id="nav-schedules" aria-controls="view-schedules" aria-current="page">Schedules</button></li>
          <li><button class="nav-item" id="nav-members" aria-controls="view-members">Members</button></li>
        </ul>
      </nav>
      <main class="content" id="main-content">
  <div class="grid grid-2">
    <rh-card>
      <h2 slot="heading">Current Shift</h2>
      {% if current_members and current_members|length > 0 %}
        <p><strong>On Shift:</strong>
          {% for m in current_members %}
            {{ m.name }}{% if not loop.last %}, {% endif %}
          {% endfor %}
        </p>
        <p><strong>Started (UTC):</strong> {{ current_started_utc }}</p>
      {% elif current_member %}
        <p><strong>On Shift:</strong> {{ current_member.name }}</p>
        <p><strong>Started (UTC):</strong> {{ current_started_utc }}</p>
      {% else %}
        <p>No current shift.</p>
      {% endif %}
    </rh-card>

    <rh-card>
      <h2 slot="heading">Next Shift</h2>
      {% if next_member %}
        <p><strong>Next:</strong> {{ next_member.name }}</p>
        <p><strong>Starts (UTC):</strong> {{ next_start_utc }}</p>
      {% else %}
        <p>No upcoming shifts configured.</p>
      {% endif %}
    </rh-card>
  </div>

  <rh-divider></rh-divider>

  <rh-card>
    <h2 slot="heading">24h Timeline</h2>
    <div id="timeline" class="timeline">
      <div class="timeline-track" id="timeline-track"></div>
      <div class="timeline-ticks" id="timeline-ticks"></div>
    </div>
    <p class="hint">Timezone: <code id="timeline-tz">UTC</code> · Date: <code id="timeline-date"></code></p>
  </rh-card>

  <section id="view-schedules" role="region" aria-labelledby="nav-schedules">
  

  <rh-card>
    <h2 slot="heading">Schedules</h2>
    {% if schedules|length == 0 %}
      <p>No schedules. Add one below.</p>
    {% else %}
      <form method="post" action="/schedule/delete" aria-labelledby="schedules-caption">
        <table>
          <caption id="schedules-caption" class="sr-only">Select schedules to delete</caption>
          <thead>
            <tr>
              <th style="width:32px; text-align:center"><input type="checkbox" id="check-all-schedules" aria-label="Select all schedules" /></th>
              <th>Member</th>
              <th>Range / Cron</th>
              <th>Days</th>
              <th>Timezone</th>
              <th>Active</th>
            </tr>
          </thead>
          <tbody>
          {% for s in schedules %}
            <tr class="schedule-row{% if not s.active %} is-inactive{% endif %}">
              <td style="text-align:center"><input type="checkbox" name="schedule_ids" value="{{ s.id }}" aria-label="Select schedule" /></td>
              <td>
                {% set m = (members | selectattr('id','equalto', s.member_id) | list | first) %}
                {{ m.name if m else 'Unknown' }}
              </td>
              <td>
                {% if s.cron %}
                  <code>{{ s.cron }}</code>
                {% else %}
                  <code>{{ s.start_time }}</code> – <code>{{ s.end_time or 'next shift' }}</code>
                {% endif %}
              </td>
              <td>
                {% if s.cron %}
                  —
                {% else %}
                  {% set day_names = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'] %}
                  {% for d in s.days %}{{ day_names[d] }}{% if not loop.last %}, {% endif %}{% endfor %}
                {% endif %}
              </td>
              <td>{{ s.timezone }}</td>
              <td style="text-align:center">
                <input type="checkbox" class="toggle-active" data-id="{{ s.id }}" {% if s.active %}checked{% endif %} aria-label="Toggle active" />
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
          <button type="submit" id="delete-selected-schedules" disabled>Delete selected</button>
        </div>
      </form>
    {% endif %}
  </rh-card>

  <rh-card class="spaced-section">
    <h3 class="section-spacer" slot="heading">Add Schedule</h3>
    <form method="post" action="/schedule/add">
      <label>Member
        <select name="member_id" required>
          <option value="" disabled {% if not new_member_id %}selected{% endif %}>Select member</option>
          {% for m in members %}
          <option value="{{ m.id }}" {% if new_member_id and m.id == new_member_id %}selected{% endif %}>{{ m.name }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Start time
        <input name="start_time" type="time" required />
      </label>
      <label>End time (optional)
        <input name="end_time" type="time" />
      </label>
      <fieldset style="border:0; padding:0; margin: 8px 0">
        <legend class="sr-only">Days of week</legend>
        <label style="display:inline-flex; align-items:center; gap:6px; margin-right:8px"><input type="checkbox" name="days" value="0" checked /> Mon</label>
        <label style="display:inline-flex; align-items:center; gap:6px; margin-right:8px"><input type="checkbox" name="days" value="1" checked /> Tue</label>
        <label style="display:inline-flex; align-items:center; gap:6px; margin-right:8px"><input type="checkbox" name="days" value="2" checked /> Wed</label>
        <label style="display:inline-flex; align-items:center; gap:6px; margin-right:8px"><input type="checkbox" name="days" value="3" checked /> Thu</label>
        <label style="display:inline-flex; align-items:center; gap:6px; margin-right:8px"><input type="checkbox" name="days" value="4" checked /> Fri</label>
        <label style="display:inline-flex; align-items:center; gap:6px; margin-right:8px"><input type="checkbox" name="days" value="5" checked /> Sat</label>
        <label style="display:inline-flex; align-items:center; gap:6px; margin-right:8px"><input type="checkbox" name="days" value="6" checked /> Sun</label>
      </fieldset>
      <label>Timezone
        <input name="timezone" type="text" placeholder="IANA (e.g., Europe/Berlin, America/New_York) or abbr (IST)" value="UTC" />
      </label>
      <button type="submit">Add</button>
      <p class="hint">If end time is empty, the shift ends when the next shift starts. Only shifts with both start and end times can overlap.</p>
      <p class="hint">Timezone examples: <code>UTC</code>, <code>Europe/Berlin</code>, <code>America/New_York</code>, <code>Asia/Kolkata</code> (abbr: <code>IST</code>)</p>
    </form>
  </rh-card>
  </section>

  <section id="view-members" role="region" aria-labelledby="nav-members" hidden>
    <rh-card>
      <h2 slot="heading">Members</h2>
      {% if members|length == 0 %}
        <p>No members yet. Add one below.</p>
      {% else %}
        <form method="post" action="/members/delete" aria-labelledby="members-caption">
          <div id="members-caption" class="sr-only">Select members to delete</div>
          <ul style="list-style:none; padding-left:0; margin:0">
            {% for m in members %}
            <li style="display:flex; align-items:center; gap:8px; padding:4px 0; border-bottom: 1px solid var(--rhds-border);">
              <input type="checkbox" name="member_ids" value="{{ m.id }}" aria-label="Select member {{ m.name }}" />
              <span>{{ m.name }}</span>
            </li>
            {% endfor %}
          </ul>
          <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
            <button type="submit" id="delete-selected-members" disabled>Delete selected</button>
          </div>
        </form>
      {% endif %}

      <h3 class="section-spacer">Add Member</h3>
      <form method="post" action="/members/add">
        <label>Name
          <input name="name" type="text" required />
        </label>
        <button type="submit">Add</button>
      </form>
    </rh-card>
  </section>
  
  <script>
    (function() {
      const tzDefault = 'UTC';
      function hslaForIndex(index) {
        const hue = (index * 53) % 360;
        return `hsla(${hue}, 70%, 50%, 1)`;
      }

      function percentBetween(ts, start, end) {
        return (ts - start) / (end - start) * 100;
      }

      function formatDateInTz(isoUtc, tz) {
        try {
          const d = new Date(isoUtc);
          return new Intl.DateTimeFormat('en-CA', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' }).format(d);
        } catch (e) {
          const d = new Date(isoUtc);
          return d.toISOString().slice(0,10);
        }
      }

      async function renderTimeline(tz = tzDefault) {
        const res = await fetch(`/api/timeline?tz=${encodeURIComponent(tz)}`);
        if (!res.ok) return;
        const data = await res.json();
        const track = document.getElementById('timeline-track');
        const ticks = document.getElementById('timeline-ticks');
        const tzLabel = document.getElementById('timeline-tz');
        const dateLabel = document.getElementById('timeline-date');
        track.innerHTML = '';
        ticks.innerHTML = '';
        tzLabel.textContent = data.window.tz;
        dateLabel.textContent = formatDateInTz(data.window.start_utc, data.window.tz);

        const start = new Date(data.window.start_utc).getTime();
        const end = new Date(data.window.end_utc).getTime();

        // Build legend mapping member id to color index
        const memberIdToColor = new Map();
        let colorIndex = 0;

        data.segments.forEach(seg => {
          const s = new Date(seg.start_utc).getTime();
          const e = new Date(seg.end_utc).getTime();
          const left = Math.max(0, Math.min(100, percentBetween(s, start, end)));
          const right = Math.max(0, Math.min(100, percentBetween(e, start, end)));
          const width = Math.max(0, right - left);
          const schedules = Array.isArray(seg.schedules) ? seg.schedules : [];
          const count = schedules.length;
          if (count === 0) {
            const el = document.createElement('div');
            el.className = 'timeline-segment';
            el.style.left = left + '%';
            el.style.width = width + '%';
            el.style.background = '#d2d2d2';
            el.title = `No active schedule: ${new Date(seg.start_utc).toISOString().slice(11,16)}–${new Date(seg.end_utc).toISOString().slice(11,16)} UTC`;
            el.textContent = 'No active schedule';
            track.appendChild(el);
            return;
          }
          const slice = 100 / count;
          schedules.forEach((sch, i) => {
            const member = sch && sch.member ? sch.member : null;
            if (!member) return;
            if (!memberIdToColor.has(member.id)) {
              memberIdToColor.set(member.id, colorIndex++);
            }
            const idx = memberIdToColor.get(member.id);
            const color = hslaForIndex(idx);
            const el = document.createElement('div');
            el.className = 'timeline-segment';
            el.style.left = left + '%';
            el.style.width = width + '%';
            el.style.top = (i * slice) + '%';
            el.style.height = slice + '%';
            el.style.bottom = 'auto';
            el.style.background = color;
            el.title = `${member.name}: ${new Date(seg.start_utc).toISOString().slice(11,16)}–${new Date(seg.end_utc).toISOString().slice(11,16)} UTC`;
            el.textContent = member.name;
            track.appendChild(el);
          });
        });

        // Hour ticks every 3 hours
        for (let h = 0; h <= 24; h += 3) {
          const tickTime = start + h * 60 * 60 * 1000;
          const left = Math.max(0, Math.min(100, percentBetween(tickTime, start, end)));
          const tick = document.createElement('div');
          tick.className = 'timeline-tick';
          tick.style.left = left + '%';
          const label = document.createElement('span');
          label.className = 'timeline-tick-label';
          label.textContent = String(h).padStart(2,'0') + ':00';
          tick.appendChild(label);
          ticks.appendChild(tick);
        }
      }

      renderTimeline();

      // Minimal select-all + enable/disable logic
      function wireSelection(containerSelector, allSelector, submitSelector) {
        const container = document.querySelector(containerSelector);
        if (!container) return;
        const all = document.querySelector(allSelector);
        const submit = document.querySelector(submitSelector);
        function update() {
          const boxes = container.querySelectorAll('input[type="checkbox"][name]');
          const checked = container.querySelectorAll('input[type="checkbox"][name]:checked');
          if (submit) submit.disabled = checked.length === 0;
          if (all) all.checked = boxes.length > 0 && checked.length === boxes.length;
          if (all) all.indeterminate = checked.length > 0 && checked.length < boxes.length;
        }
        if (all) {
          all.addEventListener('change', () => {
            const boxes = container.querySelectorAll('input[type="checkbox"][name]');
            boxes.forEach(b => { b.checked = all.checked; });
            update();
          });
        }
        container.addEventListener('change', (e) => {
          const t = e.target;
          if (t && t.matches('input[type="checkbox"][name]')) update();
        });
        update();
      }
      wireSelection('form[action="/schedule/delete"] tbody', '#check-all-schedules', '#delete-selected-schedules');
      wireSelection('form[action="/members/delete"]', null, '#delete-selected-members');

      // Wire active toggle checkboxes
      document.addEventListener('change', async (e) => {
        const t = e.target;
        if (!(t && t.classList && t.classList.contains('toggle-active'))) return;
        const id = t.getAttribute('data-id');
        const active = t.checked ? 'true' : 'false';
        try {
          const res = await fetch(`/schedule/set_active/${encodeURIComponent(id)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json', 'X-Requested-With': 'fetch' },
            body: `active=${active}`
          });
          if (!res.ok) throw new Error('Request failed');
          // Update row style
          const row = t.closest('tr');
          if (row) row.classList.toggle('is-inactive', !t.checked);
          // Re-render timeline to reflect filtering
          renderTimeline();
        } catch (err) {
          // Revert checkbox on error
          t.checked = !t.checked;
          alert('Failed to update active state');
        }
      });

      // Sidebar navigation toggle
      function showView(viewId, triggerBtn) {
        const views = ['view-schedules', 'view-members'];
        views.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          const isTarget = id === viewId;
          el.hidden = !isTarget;
        });
        document.querySelectorAll('.nav-item').forEach(btn => {
          const isActive = btn === triggerBtn;
          btn.classList.toggle('is-active', isActive);
          if (isActive) btn.setAttribute('aria-current', 'page'); else btn.removeAttribute('aria-current');
        });
        if (viewId === 'view-schedules') renderTimeline();
      }
      const btnSchedules = document.getElementById('nav-schedules');
      const btnMembers = document.getElementById('nav-members');
      btnSchedules.addEventListener('click', () => showView('view-schedules', btnSchedules));
      btnMembers.addEventListener('click', () => showView('view-members', btnMembers));
    })();
  </script>
      </main>
    </div>
  </div>
</body>
</html>

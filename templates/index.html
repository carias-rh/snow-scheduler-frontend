<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cron Shift Scheduler</title>
  <link rel="preconnect" href="https://static.redhat.com" crossorigin>
  <link rel="stylesheet" href="https://static.redhat.com/libs/redhat/redhat-font/latest/webfonts/red-hat-font.css" />
  <link rel="stylesheet" href="/static/styles.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ee0000" />
  <script type="module">
    import 'https://unpkg.com/@rhds/elements@latest/rh-card/rh-card.js';
    import 'https://unpkg.com/@rhds/elements@latest/rh-divider/rh-divider.js';
  </script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Cron Shift Scheduler</h1>
    </header>

  <div class="grid grid-2">
    <rh-card>
      <h2 slot="heading">Current Shift</h2>
      {% if current_member %}
        <p><strong>On Shift:</strong> {{ current_member.name }}</p>
        <p><strong>Started (UTC):</strong> {{ current_started_utc }}</p>
      {% else %}
        <p>No current shift.</p>
      {% endif %}
    </rh-card>

    <rh-card>
      <h2 slot="heading">Next Shift</h2>
      {% if next_member %}
        <p><strong>Next:</strong> {{ next_member.name }}</p>
        <p><strong>Starts (UTC):</strong> {{ next_start_utc }}</p>
      {% else %}
        <p>No upcoming shifts configured.</p>
      {% endif %}
    </rh-card>
  </div>

  <rh-divider></rh-divider>

  <rh-card>
    <h2 slot="heading">24h Timeline</h2>
    <div id="timeline" class="timeline">
      <div class="timeline-track" id="timeline-track"></div>
      <div class="timeline-ticks" id="timeline-ticks"></div>
    </div>
    <p class="hint">Timezone: <code id="timeline-tz">UTC</code> · Date: <code id="timeline-date"></code></p>
  </rh-card>

  <rh-card>
    <h2 slot="heading">Schedules</h2>
    {% if schedules|length == 0 %}
      <p>No schedules. Add one below.</p>
    {% else %}
      <form method="post" action="/schedule/delete" aria-labelledby="schedules-caption">
        <table>
          <caption id="schedules-caption" class="sr-only">Select schedules to delete</caption>
          <thead>
            <tr>
              <th style="width:32px; text-align:center"><input type="checkbox" id="check-all-schedules" aria-label="Select all schedules" /></th>
              <th>Member</th>
              <th>Cron</th>
              <th>Timezone</th>
            </tr>
          </thead>
          <tbody>
          {% for s in schedules %}
            <tr>
              <td style="text-align:center"><input type="checkbox" name="schedule_ids" value="{{ s.id }}" aria-label="Select schedule" /></td>
              <td>
                {% set m = (members | selectattr('id','equalto', s.member_id) | list | first) %}
                {{ m.name if m else 'Unknown' }}
              </td>
              <td><code>{{ s.cron }}</code></td>
              <td>{{ s.timezone }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
          <button type="submit" id="delete-selected-schedules" disabled>Delete selected</button>
        </div>
      </form>
    {% endif %}
  </rh-card>

  <rh-card>
    <h3 slot="heading">Add Schedule</h3>
    <form method="post" action="/schedule/add">
      <label>Member
        <select name="member_id" required>
          <option value="" disabled selected>Select member</option>
          {% for m in members %}
          <option value="{{ m.id }}">{{ m.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label>Description
        <input name="description" type="text" placeholder="e.g., Weekdays 09:00 UTC" />
      </label>
      <label>Cron
        <input name="cron" type="text" placeholder="0 9 * * 1-5" required />
      </label>
      <label>Timezone
        <input name="timezone" type="text" placeholder="IANA (e.g., Europe/Berlin, America/New_York) or abbr (IST)" value="UTC" />
      </label>
      <button type="submit">Add</button>
      <p class="hint">Examples: <code>0 9 * * 1-5</code> (Mon–Fri 09:00), <code>0 8 * * *</code> (daily 08:00)</p>
      <p class="hint">Timezone examples: <code>UTC</code>, <code>Europe/Berlin</code>, <code>America/New_York</code>, <code>Asia/Kolkata</code> (abbr: <code>IST</code>)</p>
    </form>
  </rh-card>

  <rh-divider></rh-divider>

  <rh-card>
    <h2 slot="heading">Members</h2>
    {% if members|length == 0 %}
      <p>No members yet. Add one below.</p>
    {% else %}
      <form method="post" action="/members/delete" aria-labelledby="members-caption">
        <div id="members-caption" class="sr-only">Select members to delete</div>
        <ul style="list-style:none; padding-left:0; margin:0">
          {% for m in members %}
          <li style="display:flex; align-items:center; gap:8px; padding:4px 0; border-bottom: 1px solid var(--rhds-border);">
            <input type="checkbox" name="member_ids" value="{{ m.id }}" aria-label="Select member {{ m.name }}" />
            <span>{{ m.name }}</span>
          </li>
          {% endfor %}
        </ul>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
          <button type="submit" id="delete-selected-members" disabled>Delete selected</button>
        </div>
      </form>
    {% endif %}

    <h3>Add Member</h3>
    <form method="post" action="/members/add">
      <label>Name
        <input name="name" type="text" required />
      </label>
      <button type="submit">Add</button>
    </form>
  </rh-card>
  
  <script>
    (function() {
      const tzDefault = 'UTC';
      function hslaForIndex(index) {
        const hue = (index * 53) % 360;
        return `hsla(${hue}, 70%, 50%, 1)`;
      }

      function percentBetween(ts, start, end) {
        return (ts - start) / (end - start) * 100;
      }

      function formatDateInTz(isoUtc, tz) {
        try {
          const d = new Date(isoUtc);
          return new Intl.DateTimeFormat('en-CA', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' }).format(d);
        } catch (e) {
          const d = new Date(isoUtc);
          return d.toISOString().slice(0,10);
        }
      }

      async function renderTimeline(tz = tzDefault) {
        const res = await fetch(`/api/timeline?tz=${encodeURIComponent(tz)}`);
        if (!res.ok) return;
        const data = await res.json();
        const track = document.getElementById('timeline-track');
        const ticks = document.getElementById('timeline-ticks');
        const tzLabel = document.getElementById('timeline-tz');
        const dateLabel = document.getElementById('timeline-date');
        track.innerHTML = '';
        ticks.innerHTML = '';
        tzLabel.textContent = data.window.tz;
        dateLabel.textContent = formatDateInTz(data.window.start_utc, data.window.tz);

        const start = new Date(data.window.start_utc).getTime();
        const end = new Date(data.window.end_utc).getTime();

        // Build legend mapping member id to color index
        const memberIdToColor = new Map();
        let colorIndex = 0;

        data.segments.forEach(seg => {
          const s = new Date(seg.start_utc).getTime();
          const e = new Date(seg.end_utc).getTime();
          const left = Math.max(0, Math.min(100, percentBetween(s, start, end)));
          const right = Math.max(0, Math.min(100, percentBetween(e, start, end)));
          const width = Math.max(0, right - left);
          const member = seg.schedule && seg.schedule.member ? seg.schedule.member : null;
          let color = 'var(--rhds-border)';
          let label = '—';
          if (member) {
            if (!memberIdToColor.has(member.id)) {
              memberIdToColor.set(member.id, colorIndex++);
            }
            const idx = memberIdToColor.get(member.id);
            color = hslaForIndex(idx);
            label = member.name;
          } else {
            label = seg.schedule && seg.schedule.description ? seg.schedule.description : 'No active schedule';
            color = '#d2d2d2';
          }

          const el = document.createElement('div');
          el.className = 'timeline-segment';
          el.style.left = left + '%';
          el.style.width = width + '%';
          el.style.background = color;
          el.title = `${label}: ${new Date(seg.start_utc).toISOString().slice(11,16)}–${new Date(seg.end_utc).toISOString().slice(11,16)} UTC`;
          el.textContent = label;
          track.appendChild(el);
        });

        // Hour ticks every 3 hours
        for (let h = 0; h <= 24; h += 3) {
          const tickTime = start + h * 60 * 60 * 1000;
          const left = Math.max(0, Math.min(100, percentBetween(tickTime, start, end)));
          const tick = document.createElement('div');
          tick.className = 'timeline-tick';
          tick.style.left = left + '%';
          const label = document.createElement('span');
          label.className = 'timeline-tick-label';
          label.textContent = String(h).padStart(2,'0') + ':00';
          tick.appendChild(label);
          ticks.appendChild(tick);
        }
      }

      renderTimeline();

      // Minimal select-all + enable/disable logic
      function wireSelection(containerSelector, allSelector, submitSelector) {
        const container = document.querySelector(containerSelector);
        if (!container) return;
        const all = document.querySelector(allSelector);
        const submit = document.querySelector(submitSelector);
        function update() {
          const boxes = container.querySelectorAll('input[type="checkbox"][name]');
          const checked = container.querySelectorAll('input[type="checkbox"][name]:checked');
          if (submit) submit.disabled = checked.length === 0;
          if (all) all.checked = boxes.length > 0 && checked.length === boxes.length;
          if (all) all.indeterminate = checked.length > 0 && checked.length < boxes.length;
        }
        if (all) {
          all.addEventListener('change', () => {
            const boxes = container.querySelectorAll('input[type="checkbox"][name]');
            boxes.forEach(b => { b.checked = all.checked; });
            update();
          });
        }
        container.addEventListener('change', (e) => {
          const t = e.target;
          if (t && t.matches('input[type="checkbox"][name]')) update();
        });
        update();
      }
      wireSelection('form[action="/schedule/delete"] tbody', '#check-all-schedules', '#delete-selected-schedules');
      wireSelection('form[action="/members/delete"]', null, '#delete-selected-members');
    })();
  </script>
</div>
</body>
</html>
